<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>메뉴 관리</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <style>
    body {
      min-height: 100vh;
    }

    .input-form {
      max-width: 680px;

      margin-top: 80px;
      padding: 32px;

      background: #fff;
      -webkit-border-radius: 10px;
      -moz-border-radius: 10px;
      border-radius: 10px;
      -webkit-box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15);
      -moz-box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15);
      box-shadow: 0 8px 20px 0 rgba(0, 0, 0, 0.15);
    }
  </style>
</head>

<body style="background-color: #eeeeee;">
<div class="container">
    <div class="input-form-backgroud row">
        <div class="input-form col-md-12 mx-auto">

            <h4 class="mb-3">MENU 관리
                <button type="button" onClick="location.href='/'" class="btn btn-warning" style="height:40px;float: right;color:white">
                    X
                </button></h4>


            <form class="validation-form" name="formNm" method="post" novalidate>
                <div class="row">
                <div class="col-md-6 mb-3">
                    <label>선택한 메뉴</label>
                    <input type="text" class="form-control" id="chooseMenuNm" name="chooseMenuNm" placeholder="" value="" readonly>
                    <input type="hidden" class="form-control" id="menuId" name="menuId" placeholder="" value="" >
                </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>메뉴 명<label style="padding-left:4px;color:red">*</label></label>
                        <input type="text" class="form-control" id="menuNm" name="menuNm" placeholder="" value="" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>상위 메뉴<label style="padding-left:4px;">_</label></label>
                        <select class="form-control" id="parentId" name="parentId" required>
                            <option th:value="0">-상위 메뉴 목록-</option>
                            <option th:each="menu : ${parentMenuList}" th:value="${menu.id}" th:text="${menu.menuNm}"></option>
                        </select>
                    </div>


                </div>
                <div class="mb-3">
                    <label>메뉴 url</label>
                    <input type="text" class="form-control" id="url" name="url" placeholder="" value="" required>
                </div>
                <p style="color:red">메뉴 레벨 : '상위' 이고 메뉴 순서: '1' 이면</p>
                <p style="color:red">즉, 최상위 메뉴에는 배너를 설정할 수 있습니다.</p>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>메뉴 레벨<label style="padding-left:4px;color:red">*</label></label>
                        <select class="form-control" id="level" name="level" required>
                            <option  th:value=1 th:text="상위"></option>
                            <option  th:value=2 th:text="하위"></option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>메뉴 순서<label style="padding-left:4px;color:red">*</label></label>
                        <input type="number" class="form-control" id="menuOrder" name="menuOrder" placeholder="" value="" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>상위 타입</label>
                        <input type="text" class="form-control" id="parentType" name="parentType" placeholder="" value="" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>하위 타입</label>
                        <input type="text" class="form-control" id="childType" name="childType" placeholder="" value="" required>
                    </div>
                </div>
                <div class="mb-4"></div>
                <div class="row">
                    <div class="col">
                        <button class="btn btn-success btn-lg btn-block" type="button" onclick="fnReset()">초기화</button>
                    </div>
                    <div class="col">
                        <button class="btn btn-primary btn-lg btn-block" type="button" onclick="fnMenuSave()">저장</button>
                    </div>
                </div>
            </form>
            <hr>
            <h4>MENU LIST</h4>
            <div id="menuTable">
            <table class="table table-striped">
                <thead>
                <tr>
                    <th>메뉴 명</th>
                    <th>메뉴 URL</th>
                    <th>메뉴 레벨</th>
                    <th>메뉴 순서</th>
                    <th>상위 타입</th>
                    <th>하위 타입</th>
                    <th>작업</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="menu : ${menuList}">
                    <td th:text="${menu.menuNm}"></td>
                    <td th:text="${menu.url}"></td>
                    <td th:text="${menu.level}"></td>
                    <td th:text="${menu.menuOrder}"></td>
                    <td th:text="${menu.parentType}"></td>
                    <td th:text="${menu.childType}"></td>
                    <td>
                        <button class="btn btn-primary btn-sm"
                                th:onclick="'javascript:fnChooseMenu(\'' + ${menu.id} + '\')'">선택
                        </button>
                        <button class="btn btn-danger btn-sm"
                                th:onclick="'javascript:fnDeleteMenu(\'' + ${menu.id} + '\')'">삭제
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
    </div>
    <footer class="my-3 text-center text-small">
        <!--<p class="mb-1">&copy; 2023 JH</p>-->
    </footer>
</div>
<script src="http://code.jquery.com/jquery-latest.js"></script>
<script>

    // post 생성 함수
    function fnMenuSave() {
          const menuId = document.getElementById('menuId').value;
          const chooseMenuNm = document.getElementById('chooseMenuNm').value;
          const menuNm = document.getElementById('menuNm').value;
          const parentId = document.getElementById('parentId').value;
          const url = document.getElementById('url').value;
          const level = document.getElementById('level').value;
          const menuOrder =  window.parent.document.getElementById('menuOrder').value;
          const parentType =  window.parent.document.getElementById('parentType').value;
          const childType =  window.parent.document.getElementById('childType').value;

          if(menuNm == ''){
            alert("메뉴 명을 입력해주세요.");
            return;
          }
          if(level == ''){
            alert("메뉴 레벨을 입력해주세요.");
            return;
          }
          if(menuOrder == ''){
            alert("메뉴 순서를 입력해주세요.");
            return;
          }


          let params = {
            id: menuId,
            menuNm: menuNm,
            parentId: parentId,
            url: url,
            level: level,
            menuOrder: menuOrder,
            parentType: parentType,
            childType: childType
          }

          console.log("test : ", params);

          let ajaxUrl = '';

          if(menuId == '') {
            ajaxUrl = "/menuManagement/menuCreate";
           } else {
            ajaxUrl = "/menuManagement/menuUpdate";
           }

          ajaxPost(ajaxUrl, params, function(resData) {
            if (true) {
                alert("저장되었습니다.");
                fnGetMenuList();
                fnReset();
            } else {
                alert("메뉴 생성 실패");
            }
          });

    }

    // 메뉴 선택 함수
    function fnChooseMenu(menuId) {
        let params = {
            id: menuId
        }

        ajaxPost("/menuManagement/getMenuInfo", params, function(resData) {
            document.getElementById('menuId').value = resData.id;
            document.getElementById('chooseMenuNm').value = resData.menuNm;
            document.getElementById('menuNm').value = resData.menuNm;
            document.getElementById('parentId').value = resData.parentId;
            document.getElementById('url').value = resData.url;
            document.getElementById('level').value = resData.level;
            document.getElementById('menuOrder').value = resData.menuOrder;
            document.getElementById('parentType').value = resData.parentType;
            document.getElementById('childType').value = resData.childType;
        });
    }

    // 메뉴 삭제 함수
    function fnDeleteMenu(menuId) {

        let params = {
            id: menuId
        }

        if (confirm("정말로 삭제하시겠습니까?")) {
            ajaxDelete("/menuManagement/menuDelete", params, function(resData) {
              if (true) {
                    alert("삭제되었습니다.");
                    fnGetMenuList();
                    fnReset();
                } else {
                    alert("메뉴 삭제 실패");
                }
            });
        }
    }

    function fnGetMenuList() {

        // 메뉴 목록 조회 요청을 보내고, 조회된 목록을 화면에 갱신
        ajaxPost("/menuManagement/getMenuList", {}, function(resData) {
            $('#menuTable').replaceWith(resData);
        });
    }

    function fnReset() {
        document.getElementById('menuId').value = '';
        document.getElementById('chooseMenuNm').value = '';
        document.getElementById('menuNm').value = '';
        document.getElementById('parentId').value = '0';
        document.getElementById('url').value = '';
        document.getElementById('level').value = '1';
        document.getElementById('menuOrder').value = '';
        document.getElementById('parentType').value = '';
        document.getElementById('childType').value = '';
    }

     /**
     * 비동기 호출 함수 (POST-일반)
     * @param {string} url 비동기 호출할 주소
     * @param {object} params 매개변수
     * @param {method} callbackMethod 실행될 함수
     */
    function ajaxPost(url, params, callbackMethod) {
        $.ajax({
            contentType: 'application/json',
            type: 'POST',
            data: JSON.stringify(params),
            url: url,
            //dataType: "json",
            success : function(data) {
                callbackMethod(data);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log(jqXHR);
                alert("에러가 발생했습니다. \r\n관리자에게 문의해주십시오.");
            }
        });
    }

    /**
     * 비동기 호출 함수 (DELETE-일반)
     * @param {string} url 비동기 호출할 주소
     * @param {object} params 매개변수
     * @param {method} callbackMethod 실행될 함수
     */
     function ajaxDelete(url, params, callbackMethod) {
        $.ajax({
            contentType: 'application/json',
            type: 'DELETE',
            data: JSON.stringify(params),
            url: url,
            success : function(data) {
                callbackMethod(data);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert("에러가 발생했습니다. \r\n관리자에게 문의해주십시오.");
            }
        });
    }
  </script>
</body>

</html>